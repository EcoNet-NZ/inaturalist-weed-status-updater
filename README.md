# iNaturalist Weed Status Updater

Provides a web app to update the status of observation fields on iNaturalist observations.

The user must authenticate using iNaturalist to be authorised to set the observation field values. This authentication is achieved using iNaturalist's [OAuth2 Authorization Code Flow](https://www.inaturalist.org/pages/api+reference#auth).

The Authorization Code Flow redirects the user to the web app, which is a VueJS app deployed as an Azure Static Web App calling a Python based Azure Serverless Function App which updates iNaturalist. 

This flow is shown in the following sequence diagram:

```mermaid
sequenceDiagram
    autonumber
    actor User
    box rgba(81,88,248,0.5) <br/>User Device<br/>
        participant cams as CAMS Weed Map
        participant br as Web Browser
    end
    box rgba(115,172,0,0.5)iNaturalist
        participant iNat as iNaturalist
    end
    box rgba(1,118,245,0.5) Azure
        participant web as iNaturalist Weed Status Updater<br/>Web App
        participant function as iNaturalist Weed Status Updater<br/>Function App
        participant env as Azure Environment
    end
    User->>cams: Select weed instance
    User->>cams: Click "Update Weed Status" button
    cams->>iNat: GET (client id, redirect uri, observation id)
    alt if new login required
        iNat->>br: iNaturalist login page HTML
        br->>User: iNaturalist login page
        User-->>br: Enter username and password
        br-->>iNat: POST username and password
    end
    iNat->>+web: REDIRECT (code, observation id)
    activate br
    web-->>-br: Weed Status Updater web page HTML
    br->>User: Weed Status Updater web page
    User->>br: Select action, enter field values, press Update Observation
    br->>+function: POST (auth_code, observation field values)
    function->>env: Read CLIENT_ID, CLIENT_SECRET, REDIRECT_URI variables
    function->>iNat: POST (CLIENT_ID, CLIENT_SECRET, REDIRECT_URI, auth_code)
    iNat-->>function: access_token
    loop For each observation field value 
        function->>iNat: POST (access_token, observation field value)
        iNat-->>function: HTTP Response Code
    end
    alt 500 on any response
        function-->>br: failure message
    else 200 on all responses
        function-->>-br: success message
    end
    br-->>User: Shows success or failure message box
    deactivate br
```

Here's a description of the numbered steps on this sequence diagram:
1. The user selects a Weed Instance on the CAMS Map (running on ArcGIS Field Map or Experience Builder). The Weed Instance must have been generated from iNaturalist (using the [iNaturalist to CAMS synchroniser](https://github.com/EcoNet-NZ/inaturalist-to-cams))
1. This shows a pop-up on the CAMS Weed Map with an "Update Weed Status" button. 
1. When the user clicks on this button it performs a GET request to the iNaturalist OAuth2 endpoint with hardcoded `client id` and `redirect uri` parameters plus a `state` parameter containing the iNaturalist `observation id` of the Weed Instance.
1. iNaturalist determines whether a new login is required. If so, iNaturalist returns the login page HTML. If not, jump to step 8.
1. The iNaturalist login page is displayed on the browser.
1. The user enters their username and password (assumed to be valid for this flow, otherwise an error is displayed and the flow stops)
1. On submitting the username and password, they are submitted as a `POST` request to iNaturalist
1. iNaturalist `REDIRECT`s the user to the iNaturalist Weed Status Updater web app (the URL of which was passed as the `redirect_uri` parameter in step 3). This redirect includes a `code` parameter containing the authorization code generated by iNaturalist and a `state` parameter containing the observation id (passed in step 3).
1. The web app returns the Weed Status Updater HTML.
1. The browser displays the Weed Status Updater.


The observation fields that are updated are defined in the [Weed Management Aotearoa NZ iNaturalist](https://www.inaturalist.org/projects/weed-management-aotearoa-nz) project.

TBC











## Project setup
```
npm install
```

### Compiles and hot-reloads for development
```
npm run serve
```

### Compiles and minifies for production
```
npm run build
```

### Lints and fixes files
```
npm run lint
```

### Customize configuration
See [Configuration Reference](https://cli.vuejs.org/config/).
